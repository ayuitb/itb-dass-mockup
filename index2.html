<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Kuesioner Kesehatan Mental - ITB</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      /* Calming green palette - soothing & peaceful */
      --primary: #6B9B7A;
      --primary-light: #9DC4A8;
      --primary-dark: #4A7D5A;
      --accent: #8FB996;
      --accent-light: #C5DEC9;

      /* Soft green gradients - calming tones */
      --gradient-1: linear-gradient(135deg, #7BA88A 0%, #9DC4A8 100%);
      --gradient-2: linear-gradient(135deg, #A8C5B0 0%, #C5DEC9 100%);
      --gradient-3: linear-gradient(135deg, #8BB89A 0%, #B5D4BC 100%);
      --gradient-warm: linear-gradient(135deg, #9DC4A8 0%, #D4E8D7 100%);

      /* Background - soft sage tint */
      --bg: #F5F9F6;
      --bg-card: #FFFFFF;
      --bg-soft: #EDF4EF;

      /* Text - warm gray-green for comfort */
      --text: #3D4A42;
      --text-secondary: #5F7367;
      --text-muted: #8A9B90;

      /* Status - harmonious with green theme */
      --success: #6B9B7A;
      --success-light: #E3F0E6;
      --warning: #B8A96C;
      --warning-light: #F9F6E7;
      --danger: #B87C7C;

      /* Borders & shadows - subtle green tint */
      --border: #D8E5DB;
      --shadow-sm: 0 1px 2px rgba(60,80,60,0.04);
      --shadow: 0 2px 8px rgba(60,80,60,0.06);
      --shadow-lg: 0 4px 12px rgba(60,80,60,0.08);

      --radius: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
      display: flex;
      flex-direction: column;
    }

    /* ========== Compact Header ========== */
    .header {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      flex-shrink: 0;
    }

    .header-inner {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--gradient-1);
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      font-size: 11px;
    }

    .logo-text {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
    }

    .logo-text span {
      display: block;
      font-size: 11px;
      font-weight: 400;
      color: var(--text-secondary);
    }

    /* ========== Compact Progress ========== */
    .progress-container {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      flex-shrink: 0;
    }

    .progress-inner {
      max-width: 600px;
      margin: 0 auto;
    }

    .progress-bar-wrap {
      height: 4px;
      background: var(--bg-soft);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-bar {
      height: 100%;
      background: var(--gradient-1);
      border-radius: var(--radius-full);
      transition: width 0.4s ease;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .progress-step.active {
      color: var(--primary-dark);
      font-weight: 600;
    }

    .progress-step.done {
      color: var(--success);
    }

    .step-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--bg-soft);
      display: grid;
      place-items: center;
      font-size: 9px;
      font-weight: 600;
    }

    .progress-step.active .step-dot {
      background: var(--primary);
      color: white;
    }

    .progress-step.done .step-dot {
      background: var(--success);
      color: white;
    }

    @media (max-width: 600px) {
      .progress-step span:not(.step-dot) { display: none; }
    }

    /* ========== Main - Full Height ========== */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .main-inner {
      width: 100%;
      max-width: 800px;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ========== Compact Cards ========== */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .card-hero {
      padding: 24px 28px;
      text-align: center;
      background: var(--gradient-1);
      color: white;
    }

    .card-hero h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .card-hero p {
      font-size: 13px;
      opacity: 0.9;
    }

    .card-body {
      padding: 20px 28px;
    }

    /* ========== Compact Info Grid ========== */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .info-card {
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: white;
    }

    .info-card h3 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .info-card p {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* ========== Compact Buttons ========== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-soft);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 10px 14px;
    }

    .btn-ghost:hover {
      background: var(--bg-soft);
    }

    .btn-full { width: 100%; }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    /* ========== Compact Checkboxes ========== */
    .checkbox-card {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      margin-bottom: 8px;
      background: white;
    }

    .checkbox-card:hover {
      border-color: var(--primary-light);
    }

    .checkbox-card.checked {
      border-color: var(--primary);
      background: rgba(107, 155, 122, 0.05);
    }

    .custom-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 4px;
      display: grid;
      place-items: center;
      flex-shrink: 0;
      font-size: 10px;
      margin-top: 1px;
    }

    .checkbox-card.checked .custom-checkbox {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .checkbox-card input { display: none; }

    .checkbox-label {
      font-size: 12px;
      color: var(--text);
      line-height: 1.4;
    }

    /* ========== Alert ========== */
    .alert {
      padding: 10px 12px;
      border-radius: var(--radius);
      font-size: 11px;
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 12px;
    }

    .alert-warning {
      background: var(--warning-light);
      color: #8B7D55;
    }

    .alert-success {
      background: var(--success-light);
      color: #4A7D5A;
    }

    /* ========== DASS Layout - Sidebar + Question ========== */
    .dass-wrap {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 16px;
      align-items: start;
      height: 100%;
    }

    @media (max-width: 700px) {
      .dass-wrap { grid-template-columns: 1fr; }
      .dass-sidebar { display: none; }
    }

    .dass-sidebar {
      background: white;
      border-radius: var(--radius-lg);
      padding: 14px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: sticky;
      top: 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .sidebar-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .sidebar-badge {
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-size: 10px;
      font-weight: 600;
      background: var(--bg-soft);
      color: var(--text-secondary);
    }

    .sidebar-badge.complete {
      background: var(--success-light);
      color: #4A7D5A;
    }

    /* Progress Chips in Sidebar */
    .progress-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .chip {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-muted);
      transition: all 0.15s ease;
    }

    .chip:hover {
      border-color: var(--primary-light);
      background: rgba(107, 155, 122, 0.08);
    }

    .chip.filled {
      background: var(--success-light);
      border-color: var(--success);
      color: #4A7D5A;
    }

    .chip.current {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      box-shadow: 0 0 0 2px rgba(107, 155, 122, 0.25);
    }

    .sidebar-hint {
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    /* Question Card - Right Side */
    .question-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .question-header {
      padding: 12px 18px;
      background: var(--bg-soft);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .question-number {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .q-num {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      font-size: 13px;
    }

    .q-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .q-label strong {
      display: block;
      font-size: 12px;
      color: var(--text);
    }

    .question-body {
      padding: 14px 18px;
      flex: 1;
    }

    .question-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .question-hint {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* Answer Options - Right Side */
    .answer-options {
      display: flex;
      gap: 8px;
    }

    .answer-option {
      flex: 1;
      padding: 14px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s ease;
      background: white;
      text-align: center;
    }

    .answer-option:hover {
      border-color: var(--primary-light);
      background: rgba(107, 155, 122, 0.05);
    }

    .answer-option.selected {
      border-color: var(--primary);
      background: rgba(107, 155, 122, 0.10);
    }

    .answer-option input { display: none; }

    .answer-num {
      width: 32px;
      height: 32px;
      background: var(--bg-soft);
      border-radius: 8px;
      display: inline-grid;
      place-items: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .answer-option.selected .answer-num {
      background: var(--primary);
      color: white;
    }

    .answer-label {
      font-weight: 500;
      font-size: 10px;
      color: var(--text);
      display: block;
    }

    /* Question Navigation */
    .question-nav {
      padding: 10px 18px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--bg-soft);
    }

    .nav-info {
      font-size: 10px;
      color: var(--text-muted);
    }

    .nav-keys {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 9px;
      color: var(--text-muted);
    }

    .kbd {
      padding: 2px 5px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 9px;
    }

    /* ========== Image Reflection ========== */
    .image-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .image-header {
      padding: 14px 20px;
      background: var(--gradient-3);
      color: #3D4A42;
    }

    .image-header h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .image-header p {
      font-size: 11px;
      opacity: 0.8;
    }

    .image-body {
      padding: 16px 20px;
    }

    .image-prompt {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .image-container {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 14px;
      background: var(--bg-soft);
    }

    .image-container img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      display: block;
    }

    .image-placeholder {
      width: 100%;
      height: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #E8F0EA 0%, #D4E8D7 100%);
      color: var(--text-secondary);
    }

    .image-placeholder .icon {
      font-size: 48px;
      margin-bottom: 8px;
      opacity: 0.6;
    }

    .image-placeholder span {
      font-size: 12px;
    }

    .image-input-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      display: block;
    }

    .image-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      line-height: 1.5;
    }

    .image-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(107, 155, 122, 0.1);
    }

    .image-textarea::placeholder {
      color: var(--text-muted);
    }

    .image-nav {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--bg-soft);
    }

    .image-progress {
      display: flex;
      gap: 6px;
    }

    .image-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s ease;
    }

    .image-dot.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    .image-dot.filled {
      background: var(--success);
    }

    /* ========== Canvas Collage Section ========== */
    .canvas-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .canvas-header {
      padding: 14px 20px;
      background: linear-gradient(135deg, #A8C5B0 0%, #8FB996 100%);
      color: #3D4A42;
    }

    .canvas-header h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .canvas-header p {
      font-size: 11px;
      opacity: 0.8;
    }

    .canvas-body {
      padding: 16px 20px;
    }

    .canvas-layout {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 14px;
    }

    @media (max-width: 600px) {
      .canvas-layout {
        grid-template-columns: 1fr;
      }
    }

    .objects-panel {
      background: var(--bg-soft);
      border-radius: var(--radius);
      padding: 10px;
      border: 1px solid var(--border);
    }

    .objects-panel h4 {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .objects-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    .draggable-object {
      width: 38px;
      height: 38px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      display: grid;
      place-items: center;
      cursor: grab;
      font-size: 20px;
      transition: all 0.15s ease;
      user-select: none;
    }

    .draggable-object:hover {
      border-color: var(--primary);
      transform: scale(1.05);
      box-shadow: var(--shadow);
    }

    .draggable-object:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    .draggable-object.dragging {
      opacity: 0.5;
    }

    .color-picker-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .color-picker-section h4 {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .color-picker-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .color-input-wrapper {
      position: relative;
      width: 40px;
      height: 40px;
    }

    .color-input {
      width: 48px;
      height: 36px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      padding: 0;
      background: none;
    }

    .color-input::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .color-input::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
    }

    .color-input::-moz-color-swatch {
      border: none;
      border-radius: 6px;
    }

    .color-input:hover {
      border-color: var(--primary);
    }

    .color-value {
      font-size: 11px;
      font-family: monospace;
      color: var(--text-secondary);
      background: var(--bg-soft);
      padding: 4px 8px;
      border-radius: 4px;
      flex: 1;
    }

    .color-label {
      font-size: 12px;
      font-family: monospace;
      color: var(--text-secondary);
      padding: 4px 8px;
      background: var(--bg-soft);
      border-radius: 4px;
    }

    .color-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .color-preset {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .color-preset:hover {
      transform: scale(1.15);
      z-index: 1;
      border-color: var(--text);
    }

    .canvas-area {
      flex: 1;
    }

    .canvas-container {
      width: 100%;
      height: 340px;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
      background: #FFFFFF;
      transition: background-color 0.3s ease;
    }

    .canvas-container.drag-over {
      border-color: var(--primary);
      background-color: rgba(107, 155, 122, 0.05);
    }

    .canvas-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-muted);
      pointer-events: none;
    }

    .canvas-placeholder .icon {
      font-size: 32px;
      margin-bottom: 6px;
      opacity: 0.5;
    }

    .canvas-placeholder span {
      font-size: 11px;
      display: block;
    }

    .canvas-placeholder.hidden {
      display: none;
    }

    .placed-object {
      position: absolute;
      cursor: move;
      user-select: none;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .placed-object .emoji {
      transition: font-size 0.1s ease;
    }

    .placed-object .controls {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 2px;
      background: white;
      border-radius: 6px;
      padding: 2px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .placed-object:hover .controls {
      display: flex;
    }

    .placed-object .ctrl-btn {
      width: 20px;
      height: 20px;
      border: none;
      background: var(--bg-soft);
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }

    .placed-object .ctrl-btn:hover {
      background: var(--primary-light);
    }

    .placed-object .ctrl-btn.delete {
      color: var(--danger);
    }

    .placed-object .ctrl-btn.delete:hover {
      background: #FFE6E6;
    }

    .placed-object .size-indicator {
      position: absolute;
      bottom: -16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      color: var(--text-muted);
      background: white;
      padding: 1px 4px;
      border-radius: 3px;
      display: none;
      white-space: nowrap;
    }

    .placed-object:hover .size-indicator {
      display: block;
    }

    .canvas-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .canvas-nav {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--bg-soft);
    }

    /* Review canvas preview - same size as canvas */
    .canvas-preview {
      width: 100%;
      height: 340px;
      border-radius: var(--radius);
      border: 2px dashed var(--border);
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
    }

    .canvas-preview-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 11px;
    }

    /* ========== Voice Recording - Compact ========== */
    .voice-card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .voice-header {
      padding: 14px 20px;
      background: var(--gradient-2);
      color: #3D4A42;
    }

    .voice-header h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .voice-header p {
      font-size: 11px;
      opacity: 0.8;
    }

    .voice-body {
      padding: 16px 20px;
    }

    .voice-question {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .recorder-box {
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      background: var(--bg-soft);
      margin-bottom: 12px;
    }

    .recorder-timer {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      font-variant-numeric: tabular-nums;
    }

    .recorder-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.recording {
      background: var(--danger);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .rec-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .rec-btn:hover {
      background: var(--primary-dark);
    }

    .rec-btn.recording {
      background: var(--danger);
    }

    .playback-row {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-soft);
      border-radius: var(--radius);
      margin-top: 10px;
    }

    .playback-row.active {
      display: flex;
    }

    .playback-row audio {
      flex: 1;
      height: 32px;
    }

    .text-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-soft);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .textarea-wrap {
      display: none;
      margin-top: 10px;
    }

    .textarea-wrap.active { display: block; }

    .textarea-wrap textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    .textarea-wrap textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ========== Review - Compact ========== */
    .review-section {
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 14px;
      margin-bottom: 10px;
    }

    .review-section h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .review-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      background: var(--bg-soft);
      border-radius: var(--radius);
      margin-bottom: 6px;
      cursor: pointer;
    }

    .review-item:last-child { margin-bottom: 0; }

    .review-item-left strong {
      font-size: 12px;
      color: var(--text);
    }

    .review-item-left span {
      font-size: 10px;
      color: var(--text-secondary);
      display: block;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 10px;
      font-weight: 600;
    }

    .status-badge.success {
      background: var(--success-light);
      color: #4A7D5A;
    }

    .status-badge.warning {
      background: var(--warning-light);
      color: #8B7D55;
    }

    /* ========== Done - Compact ========== */
    .done-card {
      text-align: center;
      padding: 32px 28px;
    }

    .done-icon {
      width: 64px;
      height: 64px;
      background: var(--success-light);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 28px;
      margin: 0 auto 16px;
    }

    .done-card h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .done-card p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* ========== Confetti ========== */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    /* ========== Utilities ========== */
    .spacer { height: 16px; }
    .spacer-sm { height: 10px; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-secondary); font-size: 11px; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">ITB</div>
        <div class="logo-text">
          Kuesioner Kesehatan Mental
          <span>Riset AI for Mental Health</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Progress -->
  <div class="progress-container">
    <div class="progress-inner">
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div class="progress-steps">
        <div class="progress-step active" data-step="welcome">
          <span class="step-dot">1</span><span>Mulai</span>
        </div>
        <div class="progress-step" data-step="consent">
          <span class="step-dot">2</span><span>Setuju</span>
        </div>
        <div class="progress-step" data-step="dass">
          <span class="step-dot">3</span><span>DASS</span>
        </div>
        <div class="progress-step" data-step="voice">
          <span class="step-dot">4</span><span>Suara</span>
        </div>
        <div class="progress-step" data-step="image">
          <span class="step-dot">5</span><span>Gambar</span>
        </div>
        <div class="progress-step" data-step="canvas">
          <span class="step-dot">6</span><span>Kolase</span>
        </div>
        <div class="progress-step" data-step="review">
          <span class="step-dot">7</span><span>Kirim</span>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div class="main-inner">
      <!-- Welcome Screen -->
      <section class="screen active" id="screen-welcome">
        <div class="card">
          <div class="card-hero">
            <h1>Selamat Datang!</h1>
            <p>Kuesioner singkat untuk memahami kondisi kesehatan mentalmu</p>
          </div>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-card">
                <h3>&#128202; Screening</h3>
                <p>Bukan diagnosis klinis, hanya alat bantu mengenali kondisimu.</p>
              </div>
              <div class="info-card">
                <h3>&#128274; Privasi</h3>
                <p>Jawabanmu rahasia, hanya diakses tim peneliti.</p>
              </div>
              <div class="info-card">
                <h3>&#9201; 10-15 Menit</h3>
                <p>Waktu yang dibutuhkan untuk menyelesaikan.</p>
              </div>
              <div class="info-card">
                <h3>&#127775; Feedback</h3>
                <p>Dapatkan insight tentang kondisimu.</p>
              </div>
            </div>

            <button class="btn btn-primary btn-full" id="btnStart">
              Mulai Kuesioner &#10132;
            </button>

            <div class="spacer-sm"></div>
            <p class="text-muted text-center">Bagian dari penelitian Tematik ITB</p>
          </div>
        </div>
      </section>

      <!-- Consent Screen -->
      <section class="screen" id="screen-consent">
        <div class="card">
          <div class="card-hero" style="background: var(--gradient-3);">
            <h1>Persetujuan Partisipasi</h1>
            <p>Baca informasi berikut sebelum melanjutkan</p>
          </div>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-card">
                <h3>&#127919; Tujuan</h3>
                <p>Pengembangan AI untuk kesehatan mental mahasiswa.</p>
              </div>
              <div class="info-card">
                <h3>&#128171; Manfaat</h3>
                <p>Feedback tentang kondisi kesehatan mentalmu.</p>
              </div>
              <div class="info-card">
                <h3>&#128274; Kerahasiaan</h3>
                <p>Data dienkripsi, hanya tim peneliti yang akses.</p>
              </div>
              <div class="info-card">
                <h3>&#9208; Hak Mundur</h3>
                <p>Bisa berhenti kapan saja sebelum mengirim.</p>
              </div>
            </div>

            <div class="alert alert-warning">
              <span>&#9888;</span>
              <div>Butuh bantuan segera? Hubungi layanan konseling kampus.</div>
            </div>

            <div class="checkbox-card" id="check1">
              <div class="custom-checkbox">&#10003;</div>
              <input type="checkbox" id="c1">
              <label class="checkbox-label">Saya paham ini <strong>bukan diagnosis klinis</strong>.</label>
            </div>

            <div class="checkbox-card" id="check2">
              <div class="custom-checkbox">&#10003;</div>
              <input type="checkbox" id="c2">
              <label class="checkbox-label">Saya setuju data digunakan untuk <strong>penelitian ITB</strong>.</label>
            </div>

            <div class="spacer-sm"></div>

            <div class="btn-group">
              <button class="btn btn-secondary" id="btnConsentBack">&#8592; Kembali</button>
              <button class="btn btn-primary" id="btnConsentNext" disabled style="flex: 1;">
                Setuju & Lanjut &#10132;
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- DASS-21 Screen -->
      <section class="screen" id="screen-dass">
        <div class="dass-wrap">
          <!-- LEFT: Sidebar with Progress Chips -->
          <aside class="dass-sidebar">
            <div class="sidebar-header">
              <h3>Progres</h3>
              <span class="sidebar-badge" id="dassBadge">0/21</span>
            </div>
            <div class="progress-chips" id="progressChips"></div>
            <p class="sidebar-hint">Klik nomor untuk lompat ke pertanyaan. Gunakan keyboard 0-3 untuk menjawab.</p>
          </aside>

          <!-- RIGHT: Question Card -->
          <div class="question-card">
            <div class="question-header">
              <div class="question-number">
                <div class="q-num" id="qNum">1</div>
                <div class="q-label">
                  <span>Pertanyaan</span>
                  <strong id="qProgress">1 dari 21</strong>
                </div>
              </div>
              <div class="nav-keys">
                <span class="kbd">0</span><span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span> untuk jawab
              </div>
            </div>

            <div class="question-body">
              <p class="question-text" id="qText">Saya merasa sulit untuk beristirahat.</p>
              <p class="question-hint">Pilih berdasarkan yang kamu rasakan dalam 7 hari terakhir</p>

              <div class="answer-options" id="answerOptions">
                <label class="answer-option" data-value="0">
                  <input type="radio" name="dass" value="0">
                  <span class="answer-num">0</span>
                  <span class="answer-label">Tidak Pernah</span>
                </label>
                <label class="answer-option" data-value="1">
                  <input type="radio" name="dass" value="1">
                  <span class="answer-num">1</span>
                  <span class="answer-label">Kadang</span>
                </label>
                <label class="answer-option" data-value="2">
                  <input type="radio" name="dass" value="2">
                  <span class="answer-num">2</span>
                  <span class="answer-label">Sering</span>
                </label>
                <label class="answer-option" data-value="3">
                  <input type="radio" name="dass" value="3">
                  <span class="answer-num">3</span>
                  <span class="answer-label">Selalu</span>
                </label>
              </div>
            </div>

            <div class="question-nav">
              <button class="btn btn-ghost" id="btnDassPrev">&#8592; Sebelumnya</button>
              <div class="nav-info">
                <span class="kbd">&#8592;</span> <span class="kbd">&#8594;</span> navigasi
              </div>
              <button class="btn btn-primary" id="btnDassNext">Berikutnya &#8594;</button>
            </div>
          </div>
        </div>

        <div class="spacer-sm"></div>
        <div class="text-center">
          <button class="btn btn-secondary" id="btnGoVoice">Lanjut ke Refleksi Suara &#10132;</button>
        </div>
      </section>

      <!-- Voice Screen -->
      <section class="screen" id="screen-voice">
        <div class="voice-card">
          <div class="voice-header">
            <h2>Refleksi Singkat</h2>
            <p>Pertanyaan <span id="voiceNum">1</span> dari <span id="voiceTotal">9</span></p>
          </div>

          <div class="voice-body">
            <p class="voice-question" id="voiceQuestion">Apa yang sering dipikirkan mengenai masa lalu?</p>

            <div class="recorder-box">
              <div class="recorder-timer" id="recTimer">00:00</div>
              <div class="recorder-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="recStatus">Siap merekam</span>
              </div>
              <button class="rec-btn" id="btnRecord" title="Rekam">&#9679;</button>
              <p class="text-muted" style="margin-top: 10px;">Maks 2 menit</p>
            </div>

            <div class="playback-row" id="playbackRow">
              <audio id="audioPlayer" controls></audio>
              <button class="btn btn-ghost" id="btnReRecord">Ulang</button>
              <button class="btn btn-ghost" id="btnDeleteRec" style="color: var(--danger);">Hapus</button>
            </div>

            <div class="text-toggle" id="textToggle">
              <input type="checkbox" id="toggleText">
              <label>&#9997; Ketik jawaban</label>
            </div>

            <div class="textarea-wrap" id="textareaWrap">
              <textarea id="voiceTextInput" placeholder="Ketik jawabanmu..."></textarea>
            </div>
          </div>
        </div>

        <div class="spacer-sm"></div>

        <div class="btn-group">
          <button class="btn btn-secondary" id="btnVoicePrev">&#8592;</button>
          <button class="btn btn-ghost" id="btnVoiceSkip">Lewati</button>
          <button class="btn btn-primary" id="btnVoiceNext" style="flex: 1;">Berikutnya &#8594;</button>
        </div>

        <div class="spacer-sm"></div>
        <div class="text-center">
          <button class="btn btn-secondary" id="btnGoImage">Lanjut ke Gambar &#10132;</button>
        </div>
      </section>

      <!-- Image Reflection Screen -->
      <section class="screen" id="screen-image">
        <div class="image-card">
          <div class="image-header">
            <h2>Refleksi Gambar</h2>
            <p>Gambar <span id="imageNum">1</span> dari <span id="imageTotal">3</span></p>
          </div>

          <div class="image-body">
            <p class="image-prompt" id="imagePrompt">Perhatikan gambar berikut, lalu tuliskan apa yang kamu rasakan atau pikirkan.</p>

            <div class="image-container">
              <div class="image-placeholder" id="imagePlaceholder">
                <span class="icon">&#128444;</span>
                <span>Gambar <span id="imageNumDisplay">1</span></span>
              </div>
              <!-- Will be replaced with actual image -->
              <!-- <img id="reflectionImage" src="" alt="Gambar refleksi"> -->
            </div>

            <label class="image-input-label">Tuliskan perasaan atau pikiranmu:</label>
            <textarea class="image-textarea" id="imageTextInput" placeholder="Ceritakan apa yang kamu rasakan saat melihat gambar ini..."></textarea>
          </div>

          <div class="image-nav">
            <button class="btn btn-ghost" id="btnImagePrev">&#8592;</button>
            <div class="image-progress">
              <span class="image-dot active" data-idx="0"></span>
              <span class="image-dot" data-idx="1"></span>
              <span class="image-dot" data-idx="2"></span>
            </div>
            <button class="btn btn-primary" id="btnImageNext">Berikutnya &#8594;</button>
          </div>
        </div>

        <div class="spacer-sm"></div>
        <div class="text-center">
          <button class="btn btn-secondary" id="btnGoCanvas">Lanjut ke Kolase &#10132;</button>
        </div>
      </section>

      <!-- Canvas Collage Screen -->
      <section class="screen" id="screen-canvas">
        <div class="canvas-card">
          <div class="canvas-header">
            <h2>Buat Kolase Perasaanmu</h2>
            <p>Seret objek ke canvas untuk mengekspresikan perasaanmu</p>
          </div>

          <div class="canvas-body">
            <div class="canvas-layout">
              <!-- Objects Panel (Left) -->
              <div class="objects-panel">
                <h4>Objek</h4>
                <div class="objects-list" id="objectsList">
                  <div class="draggable-object" data-emoji="üòä" draggable="true">üòä</div>
                  <div class="draggable-object" data-emoji="üò¢" draggable="true">üò¢</div>
                  <div class="draggable-object" data-emoji="üò∞" draggable="true">üò∞</div>
                  <div class="draggable-object" data-emoji="üòå" draggable="true">üòå</div>
                  <div class="draggable-object" data-emoji="üí™" draggable="true">üí™</div>
                  <div class="draggable-object" data-emoji="‚ù§Ô∏è" draggable="true">‚ù§Ô∏è</div>
                  <div class="draggable-object" data-emoji="‚≠ê" draggable="true">‚≠ê</div>
                  <div class="draggable-object" data-emoji="üåà" draggable="true">üåà</div>
                  <div class="draggable-object" data-emoji="üå∏" draggable="true">üå∏</div>
                  <div class="draggable-object" data-emoji="üçÉ" draggable="true">üçÉ</div>
                  <div class="draggable-object" data-emoji="‚òÅÔ∏è" draggable="true">‚òÅÔ∏è</div>
                  <div class="draggable-object" data-emoji="üåô" draggable="true">üåô</div>
                  <div class="draggable-object" data-emoji="üî•" draggable="true">üî•</div>
                  <div class="draggable-object" data-emoji="üíß" draggable="true">üíß</div>
                  <div class="draggable-object" data-emoji="üè†" draggable="true">üè†</div>
                  <div class="draggable-object" data-emoji="üìö" draggable="true">üìö</div>
                </div>

                <div class="color-picker-section">
                  <h4>Warna Latar</h4>
                  <div class="color-picker-row">
                    <input type="color" id="bgColorPicker" class="color-input" value="#FFFFFF" title="Pilih warna latar">
                    <span class="color-label" id="colorLabel">#FFFFFF</span>
                  </div>
                  <div class="color-presets">
                    <div class="color-preset" data-color="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ddd;" title="Putih"></div>
                    <div class="color-preset" data-color="#E8F5E9" style="background: #E8F5E9;" title="Hijau Muda"></div>
                    <div class="color-preset" data-color="#E3F2FD" style="background: #E3F2FD;" title="Biru Muda"></div>
                    <div class="color-preset" data-color="#F3E5F5" style="background: #F3E5F5;" title="Ungu Muda"></div>
                    <div class="color-preset" data-color="#FCE4EC" style="background: #FCE4EC;" title="Pink Muda"></div>
                    <div class="color-preset" data-color="#FFF9C4" style="background: #FFF9C4;" title="Kuning Muda"></div>
                    <div class="color-preset" data-color="#2C3E50" style="background: #2C3E50;" title="Biru Gelap"></div>
                    <div class="color-preset" data-color="#1A1A2E" style="background: #1A1A2E;" title="Biru Malam"></div>
                  </div>
                </div>
              </div>

              <!-- Canvas Area (Right) -->
              <div class="canvas-area">
                <div class="canvas-container" id="canvasContainer">
                  <div class="canvas-placeholder" id="canvasPlaceholder">
                    <span class="icon">&#128444;</span>
                    <span>Seret objek ke sini</span>
                  </div>
                </div>
                <div class="canvas-actions">
                  <button class="btn btn-ghost" id="btnClearCanvas" style="color: var(--danger);">Hapus Semua</button>
                </div>
              </div>
            </div>
          </div>

          <div class="canvas-nav">
            <button class="btn btn-ghost" id="btnCanvasPrev">&#8592; Sebelumnya</button>
            <span class="nav-info">Ekspresikan perasaanmu dengan bebas</span>
            <button class="btn btn-primary" id="btnCanvasNext">Lanjut ke Review &#8594;</button>
          </div>
        </div>
      </section>

      <!-- Review Screen -->
      <section class="screen" id="screen-review">
        <div class="card">
          <div class="card-hero" style="background: linear-gradient(135deg, #7BAE7F 0%, #9BC49E 100%);">
            <h1>Hampir Selesai!</h1>
            <p>Tinjau jawabanmu sebelum mengirim</p>
          </div>
          <div class="card-body">
            <div class="review-section">
              <h3>&#128203; DASS-21</h3>
              <div class="review-item" id="btnEditDass">
                <div class="review-item-left">
                  <strong>21 Pertanyaan Screening</strong>
                  <span>Klik untuk mengubah</span>
                </div>
                <span class="status-badge success" id="reviewDassBadge">Lengkap</span>
              </div>
            </div>

            <div class="review-section">
              <h3>&#127908; Refleksi Suara</h3>
              <div id="reviewVoiceList"></div>
            </div>

            <div class="review-section">
              <h3>&#128444; Refleksi Gambar</h3>
              <div id="reviewImageList"></div>
            </div>

            <div class="review-section">
              <h3>&#127912; Kolase Perasaan</h3>
              <div class="canvas-preview" id="canvasPreview">
                <div class="canvas-preview-placeholder" id="canvasPreviewPlaceholder">
                  Belum ada kolase
                </div>
              </div>
              <div id="canvasReviewActions" style="display: none;">
                <button class="btn btn-ghost" id="btnDeleteCanvas" style="color: var(--danger); font-size: 12px;">Hapus Kolase</button>
              </div>
            </div>

            <div class="checkbox-card" id="checkFinal">
              <div class="custom-checkbox">&#10003;</div>
              <input type="checkbox" id="finalCheck">
              <label class="checkbox-label">Saya siap mengirimkan kuesioner ini.</label>
            </div>

            <div class="spacer-sm"></div>

            <div class="btn-group">
              <button class="btn btn-secondary" id="btnReviewBack">&#8592; Kembali</button>
              <button class="btn btn-primary" id="btnSubmit" disabled style="flex: 1;">
                Kirim &#10004;
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Done Screen -->
      <section class="screen" id="screen-done">
        <div class="card">
          <div class="done-card">
            <div class="done-icon">&#10004;</div>
            <h1>Terima Kasih!</h1>
            <p>Kuesionermu sudah berhasil dikirim.</p>

            <div class="alert alert-success">
              <span>&#128161;</span>
              <div>Butuh bantuan? Hubungi layanan konseling kampus ITB.</div>
            </div>

            <div class="btn-group" style="justify-content: center;">
              <button class="btn btn-secondary" id="btnDownload">&#128190; Unduh Bukti</button>
              <button class="btn btn-primary" id="btnBackHome">Beranda</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <canvas class="confetti" id="confetti"></canvas>

  <script>
    const screens = ['welcome', 'consent', 'dass', 'voice', 'image', 'canvas', 'review', 'done'];
    let currentScreen = 'welcome';

    const dassItems = [
      "Saya merasa sulit untuk beristirahat.",
      "Saya merasa bibir saya kering.",
      "Saya sama sekali tidak dapat merasakan perasaan positif.",
      "Saya mengalami kesulitan bernafas (sesak padahal tidak melakukan aktivitas fisik).",
      "Saya merasa sulit untuk mengembangkan inisiatif melakukan sesuatu.",
      "Saya cenderung bereaksi berlebihan terhadap situasi.",
      "Saya mengalami gemetar (misalnya di tangan).",
      "Saya merasa menggunakan banyak energi untuk cemas.",
      "Saya khawatir akan panik dan mempermalukan diri sendiri.",
      "Saya merasa tidak ada hal yang dapat diharapkan di masa depan.",
      "Saya merasa gelisah.",
      "Saya merasa sulit untuk bersantai.",
      "Saya merasa sedih dan tertekan.",
      "Saya menjadi tidak sabar ketika mengalami penundaan.",
      "Saya merasa lemas seperti mau pingsan.",
      "Saya merasa kehilangan minat akan segala hal.",
      "Saya merasa tidak berharga sebagai manusia.",
      "Saya merasa mudah tersinggung.",
      "Saya berkeringat berlebihan padahal tidak panas/aktivitas fisik.",
      "Saya merasa takut tanpa alasan yang jelas.",
      "Saya merasa hidup tidak ada artinya."
    ];

    const voiceQuestions = [
      "Apa yang sering dipikirkan mengenai masa lalu?",
      "Apa yang sering dipikirkan saat ini?",
      "Apa yang sering dipikirkan tentang masa depan?",
      "Apa yang sudah dilakukan untuk mengatasi masalah?",
      "Apa yang diharapkan dari layanan kesehatan mental di ITB?",
      "Apakah merasa kesulitan dalam aktivitas sehari-hari (perawatan diri, tidur, makan)?",
      "Apakah sering berkonflik dengan lingkungan sekitar?",
      "Apakah kesulitan menyelesaikan tugas kuliah/pekerjaan?",
      "Apakah perasaan saat ini membuat diri/orang sekitar tertekan?"
    ];

    const dassAnswers = new Array(21).fill(null);
    const voiceData = voiceQuestions.map(() => ({ blob: null, url: null, text: "" }));

    // Image reflection data
    const imagePrompts = [
      "Perhatikan gambar berikut, lalu tuliskan apa yang kamu rasakan atau pikirkan.",
      "Amati gambar ini dengan tenang. Apa yang muncul di pikiranmu?",
      "Lihat gambar terakhir ini. Ceritakan perasaan atau pemikiranmu."
    ];
    const imageData = imagePrompts.map(() => ({ text: "" }));
    let imgIndex = 0;

    // Canvas/Collage data
    const canvasData = {
      objects: [], // { emoji, x, y, id, size }
      backgroundColor: '#FFFFFF'
    };
    let objectIdCounter = 0;
    const SIZES = [20, 28, 40, 56, 72]; // Available font sizes
    const SIZE_LABELS = ['XS', 'S', 'M', 'L', 'XL'];

    let qIndex = 0;
    let vIndex = 0;

    function setScreen(name) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(`screen-${name}`).classList.add('active');
      currentScreen = name;

      document.querySelectorAll('.progress-step').forEach(step => {
        const stepName = step.dataset.step;
        const stepIdx = screens.indexOf(stepName);
        const currentIdx = screens.indexOf(name);
        step.classList.remove('active', 'done');
        if (stepIdx < currentIdx) step.classList.add('done');
        if (stepIdx === currentIdx) step.classList.add('active');
      });

      const progress = (screens.indexOf(name) / (screens.length - 1)) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }

    // Welcome
    document.getElementById('btnStart').addEventListener('click', () => setScreen('consent'));

    // Consent
    const c1 = document.getElementById('c1');
    const c2 = document.getElementById('c2');
    const check1 = document.getElementById('check1');
    const check2 = document.getElementById('check2');
    const btnConsentNext = document.getElementById('btnConsentNext');

    function updateCheckbox(card, checkbox) {
      card.classList.toggle('checked', checkbox.checked);
      btnConsentNext.disabled = !(c1.checked && c2.checked);
    }

    check1.addEventListener('click', () => { c1.checked = !c1.checked; updateCheckbox(check1, c1); });
    check2.addEventListener('click', () => { c2.checked = !c2.checked; updateCheckbox(check2, c2); });

    document.getElementById('btnConsentBack').addEventListener('click', () => setScreen('welcome'));
    btnConsentNext.addEventListener('click', () => { setScreen('dass'); renderDassQuestion(); });

    // DASS
    function renderProgressChips() {
      const container = document.getElementById('progressChips');
      container.innerHTML = '';
      dassItems.forEach((_, idx) => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = idx + 1;
        if (dassAnswers[idx] !== null) chip.classList.add('filled');
        if (idx === qIndex) chip.classList.add('current');
        chip.addEventListener('click', () => { qIndex = idx; renderDassQuestion(); });
        container.appendChild(chip);
      });

      // Update sidebar badge
      const filled = dassAnswers.filter(v => v !== null).length;
      const badge = document.getElementById('dassBadge');
      badge.textContent = `${filled}/21`;
      badge.classList.toggle('complete', filled === 21);
    }

    function renderDassQuestion() {
      document.getElementById('qNum').textContent = qIndex + 1;
      document.getElementById('qProgress').textContent = `${qIndex + 1} dari 21`;
      document.getElementById('qText').textContent = dassItems[qIndex];

      document.querySelectorAll('.answer-option').forEach(opt => {
        const value = parseInt(opt.dataset.value);
        opt.classList.toggle('selected', dassAnswers[qIndex] === value);
        opt.querySelector('input').checked = dassAnswers[qIndex] === value;
      });

      renderProgressChips();
    }

    document.querySelectorAll('.answer-option').forEach(opt => {
      opt.addEventListener('click', () => {
        const value = parseInt(opt.dataset.value);
        dassAnswers[qIndex] = value;
        renderDassQuestion();
        setTimeout(() => { if (qIndex < 20) { qIndex++; renderDassQuestion(); } }, 250);
      });
    });

    document.getElementById('btnDassPrev').addEventListener('click', () => { if (qIndex > 0) { qIndex--; renderDassQuestion(); } });
    document.getElementById('btnDassNext').addEventListener('click', () => { if (qIndex < 20) { qIndex++; renderDassQuestion(); } });
    document.getElementById('btnGoVoice').addEventListener('click', () => { setScreen('voice'); renderVoiceQuestion(); });

    // Voice
    let mediaRecorder = null, stream = null, chunks = [], isRecording = false, timer = null, seconds = 0;
    const MAX_SECONDS = 120;

    function formatTime(sec) {
      return String(Math.floor(sec / 60)).padStart(2, '0') + ':' + String(sec % 60).padStart(2, '0');
    }

    function renderVoiceQuestion() {
      document.getElementById('voiceNum').textContent = vIndex + 1;
      document.getElementById('voiceTotal').textContent = voiceQuestions.length;
      document.getElementById('voiceQuestion').textContent = voiceQuestions[vIndex];
      document.getElementById('recTimer').textContent = '00:00';
      document.getElementById('recStatus').textContent = 'Siap merekam';
      document.getElementById('statusDot').classList.remove('recording');
      document.getElementById('btnRecord').classList.remove('recording');
      document.getElementById('btnRecord').innerHTML = '&#9679;';

      if (voiceData[vIndex].url) {
        document.getElementById('playbackRow').classList.add('active');
        document.getElementById('audioPlayer').src = voiceData[vIndex].url;
      } else {
        document.getElementById('playbackRow').classList.remove('active');
      }
      document.getElementById('voiceTextInput').value = voiceData[vIndex].text || '';
    }

    function saveVoiceText() { voiceData[vIndex].text = document.getElementById('voiceTextInput').value; }

    async function ensureMic() {
      try {
        if (stream) return true;
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return true;
      } catch { alert('Izin mikrofon belum diberikan.'); return false; }
    }

    async function startRecording() {
      if (!await ensureMic()) return;
      chunks = [];
      try { mediaRecorder = new MediaRecorder(stream); } catch { alert('Browser tidak mendukung.'); return; }
      mediaRecorder.ondataavailable = (e) => { if (e.data?.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        if (voiceData[vIndex].url) URL.revokeObjectURL(voiceData[vIndex].url);
        voiceData[vIndex].blob = blob;
        voiceData[vIndex].url = url;
        document.getElementById('playbackRow').classList.add('active');
        document.getElementById('audioPlayer').src = url;
      };
      mediaRecorder.start();
      isRecording = true;
      document.getElementById('statusDot').classList.add('recording');
      document.getElementById('recStatus').textContent = 'Merekam...';
      document.getElementById('btnRecord').classList.add('recording');
      document.getElementById('btnRecord').innerHTML = '&#9632;';
      seconds = 0;
      timer = setInterval(() => {
        seconds++;
        document.getElementById('recTimer').textContent = formatTime(seconds);
        if (seconds >= MAX_SECONDS) stopRecording();
      }, 1000);
    }

    function stopRecording() {
      if (!mediaRecorder) return;
      try { mediaRecorder.stop(); } catch {}
      isRecording = false;
      if (timer) clearInterval(timer);
      document.getElementById('statusDot').classList.remove('recording');
      document.getElementById('recStatus').textContent = 'Selesai';
      document.getElementById('btnRecord').classList.remove('recording');
      document.getElementById('btnRecord').innerHTML = '&#9679;';
    }

    document.getElementById('btnRecord').addEventListener('click', () => { if (!isRecording) startRecording(); else stopRecording(); });
    document.getElementById('btnReRecord').addEventListener('click', async () => {
      if (voiceData[vIndex].url) { URL.revokeObjectURL(voiceData[vIndex].url); voiceData[vIndex].url = null; voiceData[vIndex].blob = null; }
      document.getElementById('playbackRow').classList.remove('active');
      await startRecording();
    });
    document.getElementById('btnDeleteRec').addEventListener('click', () => {
      if (!confirm('Hapus rekaman?')) return;
      if (voiceData[vIndex].url) URL.revokeObjectURL(voiceData[vIndex].url);
      voiceData[vIndex].url = null; voiceData[vIndex].blob = null;
      document.getElementById('playbackRow').classList.remove('active');
      document.getElementById('recTimer').textContent = '00:00';
    });
    document.getElementById('textToggle').addEventListener('click', () => {
      const cb = document.getElementById('toggleText');
      cb.checked = !cb.checked;
      document.getElementById('textareaWrap').classList.toggle('active', cb.checked);
    });

    document.getElementById('btnVoicePrev').addEventListener('click', () => { saveVoiceText(); if (vIndex > 0) { vIndex--; renderVoiceQuestion(); } else setScreen('dass'); });
    document.getElementById('btnVoiceNext').addEventListener('click', () => { saveVoiceText(); if (vIndex < voiceQuestions.length - 1) { vIndex++; renderVoiceQuestion(); } else { setScreen('image'); renderImageQuestion(); } });
    document.getElementById('btnVoiceSkip').addEventListener('click', () => { saveVoiceText(); if (vIndex < voiceQuestions.length - 1) { vIndex++; renderVoiceQuestion(); } });
    document.getElementById('btnGoImage').addEventListener('click', () => { saveVoiceText(); setScreen('image'); renderImageQuestion(); });

    // Image Reflection
    function renderImageQuestion() {
      document.getElementById('imageNum').textContent = imgIndex + 1;
      document.getElementById('imageTotal').textContent = imagePrompts.length;
      document.getElementById('imageNumDisplay').textContent = imgIndex + 1;
      document.getElementById('imagePrompt').textContent = imagePrompts[imgIndex];
      document.getElementById('imageTextInput').value = imageData[imgIndex].text || '';

      // Update dots
      document.querySelectorAll('.image-dot').forEach((dot, idx) => {
        dot.classList.remove('active', 'filled');
        if (idx === imgIndex) dot.classList.add('active');
        else if (imageData[idx].text.trim()) dot.classList.add('filled');
      });
    }

    function saveImageText() {
      imageData[imgIndex].text = document.getElementById('imageTextInput').value;
    }

    document.getElementById('btnImagePrev').addEventListener('click', () => {
      saveImageText();
      if (imgIndex > 0) { imgIndex--; renderImageQuestion(); }
      else { setScreen('voice'); renderVoiceQuestion(); }
    });

    document.getElementById('btnImageNext').addEventListener('click', () => {
      saveImageText();
      if (imgIndex < imagePrompts.length - 1) { imgIndex++; renderImageQuestion(); }
      else { setScreen('canvas'); }
    });

    document.getElementById('btnGoCanvas').addEventListener('click', () => { saveImageText(); setScreen('canvas'); });

    // Clicking on dots to navigate
    document.querySelectorAll('.image-dot').forEach((dot, idx) => {
      dot.addEventListener('click', () => { saveImageText(); imgIndex = idx; renderImageQuestion(); });
    });

    // Canvas/Collage
    const canvasContainer = document.getElementById('canvasContainer');
    const canvasPlaceholder = document.getElementById('canvasPlaceholder');

    function renderCanvasObjects() {
      // Remove existing placed objects
      canvasContainer.querySelectorAll('.placed-object').forEach(el => el.remove());

      // Render all objects
      canvasData.objects.forEach(obj => {
        const el = document.createElement('div');
        el.className = 'placed-object';
        el.dataset.id = obj.id;
        el.style.left = obj.x + 'px';
        el.style.top = obj.y + 'px';

        // Emoji span
        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'emoji';
        emojiSpan.textContent = obj.emoji;
        emojiSpan.style.fontSize = (obj.size || 28) + 'px';
        el.appendChild(emojiSpan);

        // Controls container
        const controls = document.createElement('div');
        controls.className = 'controls';

        // Size down button
        const sizeDownBtn = document.createElement('button');
        sizeDownBtn.className = 'ctrl-btn';
        sizeDownBtn.innerHTML = '‚àí';
        sizeDownBtn.title = 'Perkecil';
        sizeDownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const currentIdx = SIZES.indexOf(obj.size || 28);
          if (currentIdx > 0) {
            obj.size = SIZES[currentIdx - 1];
            renderCanvasObjects();
          }
        });
        controls.appendChild(sizeDownBtn);

        // Size up button
        const sizeUpBtn = document.createElement('button');
        sizeUpBtn.className = 'ctrl-btn';
        sizeUpBtn.innerHTML = '+';
        sizeUpBtn.title = 'Perbesar';
        sizeUpBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const currentIdx = SIZES.indexOf(obj.size || 28);
          if (currentIdx < SIZES.length - 1) {
            obj.size = SIZES[currentIdx + 1];
            renderCanvasObjects();
          }
        });
        controls.appendChild(sizeUpBtn);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'ctrl-btn delete';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.title = 'Hapus';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          canvasData.objects = canvasData.objects.filter(o => o.id !== obj.id);
          renderCanvasObjects();
        });
        controls.appendChild(deleteBtn);

        el.appendChild(controls);

        // Size indicator
        const sizeIndicator = document.createElement('span');
        sizeIndicator.className = 'size-indicator';
        const sizeIdx = SIZES.indexOf(obj.size || 28);
        sizeIndicator.textContent = SIZE_LABELS[sizeIdx >= 0 ? sizeIdx : 1];
        el.appendChild(sizeIndicator);

        // Make draggable within canvas
        el.addEventListener('mousedown', startDragPlaced);
        el.addEventListener('touchstart', startDragPlaced, { passive: false });

        canvasContainer.appendChild(el);
      });

      // Toggle placeholder
      canvasPlaceholder.classList.toggle('hidden', canvasData.objects.length > 0);
    }

    // Drag placed object within canvas
    let draggedPlaced = null;
    let dragOffsetX = 0, dragOffsetY = 0;

    function startDragPlaced(e) {
      e.preventDefault();
      draggedPlaced = e.target.closest('.placed-object');
      if (!draggedPlaced) return;

      const rect = draggedPlaced.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      dragOffsetX = clientX - rect.left;
      dragOffsetY = clientY - rect.top;

      document.addEventListener('mousemove', moveDragPlaced);
      document.addEventListener('mouseup', endDragPlaced);
      document.addEventListener('touchmove', moveDragPlaced, { passive: false });
      document.addEventListener('touchend', endDragPlaced);
    }

    function moveDragPlaced(e) {
      if (!draggedPlaced) return;
      e.preventDefault();

      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const containerRect = canvasContainer.getBoundingClientRect();

      let x = clientX - containerRect.left - dragOffsetX;
      let y = clientY - containerRect.top - dragOffsetY;

      // Bounds
      x = Math.max(0, Math.min(x, containerRect.width - 40));
      y = Math.max(0, Math.min(y, containerRect.height - 40));

      draggedPlaced.style.left = x + 'px';
      draggedPlaced.style.top = y + 'px';
    }

    function endDragPlaced(e) {
      if (draggedPlaced) {
        const id = parseInt(draggedPlaced.dataset.id);
        const obj = canvasData.objects.find(o => o.id === id);
        if (obj) {
          obj.x = parseInt(draggedPlaced.style.left);
          obj.y = parseInt(draggedPlaced.style.top);
        }
      }
      draggedPlaced = null;
      document.removeEventListener('mousemove', moveDragPlaced);
      document.removeEventListener('mouseup', endDragPlaced);
      document.removeEventListener('touchmove', moveDragPlaced);
      document.removeEventListener('touchend', endDragPlaced);
    }

    // Drag from objects list to canvas
    document.querySelectorAll('.draggable-object').forEach(obj => {
      obj.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('emoji', obj.dataset.emoji);
        obj.classList.add('dragging');
      });
      obj.addEventListener('dragend', () => {
        obj.classList.remove('dragging');
      });
    });

    canvasContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      canvasContainer.classList.add('drag-over');
    });

    canvasContainer.addEventListener('dragleave', () => {
      canvasContainer.classList.remove('drag-over');
    });

    canvasContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      canvasContainer.classList.remove('drag-over');

      const emoji = e.dataTransfer.getData('emoji');
      if (!emoji) return;

      const rect = canvasContainer.getBoundingClientRect();
      const x = e.clientX - rect.left - 20;
      const y = e.clientY - rect.top - 20;

      canvasData.objects.push({
        id: ++objectIdCounter,
        emoji: emoji,
        x: Math.max(0, Math.min(x, rect.width - 50)),
        y: Math.max(0, Math.min(y, rect.height - 50)),
        size: 40 // Default to Medium size
      });

      renderCanvasObjects();
    });

    // Touch support for mobile drag
    let touchDragEmoji = null;
    document.querySelectorAll('.draggable-object').forEach(obj => {
      obj.addEventListener('touchstart', (e) => {
        touchDragEmoji = obj.dataset.emoji;
      });
    });

    canvasContainer.addEventListener('touchend', (e) => {
      if (touchDragEmoji && e.changedTouches.length > 0) {
        const touch = e.changedTouches[0];
        const rect = canvasContainer.getBoundingClientRect();

        if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
            touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
          const x = touch.clientX - rect.left - 20;
          const y = touch.clientY - rect.top - 20;

          canvasData.objects.push({
            id: ++objectIdCounter,
            emoji: touchDragEmoji,
            x: Math.max(0, Math.min(x, rect.width - 50)),
            y: Math.max(0, Math.min(y, rect.height - 50)),
            size: 40 // Default to Medium size
          });

          renderCanvasObjects();
        }
      }
      touchDragEmoji = null;
    });

    // Native color picker
    const bgColorPicker = document.getElementById('bgColorPicker');
    const colorLabel = document.getElementById('colorLabel');

    bgColorPicker.addEventListener('input', (e) => {
      const color = e.target.value.toUpperCase();
      canvasData.backgroundColor = color;
      canvasContainer.style.backgroundColor = color;
      colorLabel.textContent = color;
    });

    // Color presets
    document.querySelectorAll('.color-preset').forEach(preset => {
      preset.addEventListener('click', () => {
        const color = preset.dataset.color;
        bgColorPicker.value = color;
        canvasData.backgroundColor = color;
        canvasContainer.style.backgroundColor = color;
        colorLabel.textContent = color;
      });
    });

    // Clear canvas
    document.getElementById('btnClearCanvas').addEventListener('click', () => {
      if (canvasData.objects.length === 0) return;
      if (!confirm('Hapus semua objek di canvas?')) return;
      canvasData.objects = [];
      renderCanvasObjects();
    });

    // Canvas navigation
    document.getElementById('btnCanvasPrev').addEventListener('click', () => {
      setScreen('image');
      renderImageQuestion();
    });

    document.getElementById('btnCanvasNext').addEventListener('click', () => {
      syncReview();
      setScreen('review');
    });

    // Delete canvas from review
    document.getElementById('btnDeleteCanvas').addEventListener('click', () => {
      if (!confirm('Hapus kolase? Anda harus membuat ulang.')) return;
      canvasData.objects = [];
      canvasData.backgroundColor = '#FFFFFF';
      canvasContainer.style.backgroundColor = '#FFFFFF';
      bgColorPicker.value = '#FFFFFF';
      colorLabel.textContent = '#FFFFFF';
      renderCanvasObjects();
      syncReview();
    });

    // Review
    function syncReview() {
      const filled = dassAnswers.filter(v => v !== null).length;
      const dassBadge = document.getElementById('reviewDassBadge');
      dassBadge.className = 'status-badge ' + (filled === 21 ? 'success' : 'warning');
      dassBadge.textContent = filled === 21 ? 'Lengkap' : `${filled}/21`;

      // Voice review list
      const voiceList = document.getElementById('reviewVoiceList');
      voiceList.innerHTML = '';
      voiceQuestions.forEach((q, i) => {
        const hasAudio = !!voiceData[i].url;
        const hasText = (voiceData[i].text || '').trim().length > 0;
        const item = document.createElement('div');
        item.className = 'review-item';
        item.innerHTML = `<div class="review-item-left"><strong>Pertanyaan ${i + 1}</strong><span>${q.substring(0, 40)}...</span></div><span class="status-badge ${hasAudio ? 'success' : 'warning'}">${hasAudio ? 'Rekaman' : hasText ? 'Teks' : 'Kosong'}</span>`;
        item.addEventListener('click', () => { vIndex = i; renderVoiceQuestion(); setScreen('voice'); });
        voiceList.appendChild(item);
      });

      // Image review list
      const imageList = document.getElementById('reviewImageList');
      imageList.innerHTML = '';
      imagePrompts.forEach((p, i) => {
        const hasText = (imageData[i].text || '').trim().length > 0;
        const item = document.createElement('div');
        item.className = 'review-item';
        const preview = hasText ? imageData[i].text.substring(0, 35) + '...' : 'Belum diisi';
        item.innerHTML = `<div class="review-item-left"><strong>Gambar ${i + 1}</strong><span>${preview}</span></div><span class="status-badge ${hasText ? 'success' : 'warning'}">${hasText ? 'Terisi' : 'Kosong'}</span>`;
        item.addEventListener('click', () => { imgIndex = i; renderImageQuestion(); setScreen('image'); });
        imageList.appendChild(item);
      });

      // Canvas preview
      const canvasPreview = document.getElementById('canvasPreview');
      const canvasPreviewPlaceholder = document.getElementById('canvasPreviewPlaceholder');
      const canvasReviewActions = document.getElementById('canvasReviewActions');

      if (canvasData.objects.length > 0) {
        canvasPreviewPlaceholder.style.display = 'none';
        canvasPreview.style.backgroundColor = canvasData.backgroundColor;
        canvasPreview.style.position = 'relative';

        // Remove old preview objects
        canvasPreview.querySelectorAll('.preview-obj').forEach(el => el.remove());

        // Add preview objects (same size as canvas - no scaling needed)
        canvasData.objects.forEach(obj => {
          const el = document.createElement('span');
          el.className = 'preview-obj';
          el.textContent = obj.emoji;
          el.style.position = 'absolute';
          el.style.left = obj.x + 'px';
          el.style.top = obj.y + 'px';
          el.style.fontSize = (obj.size || 28) + 'px';
          canvasPreview.appendChild(el);
        });

        canvasReviewActions.style.display = 'block';
      } else {
        canvasPreviewPlaceholder.style.display = 'flex';
        canvasPreview.style.backgroundColor = '';
        canvasPreview.querySelectorAll('.preview-obj').forEach(el => el.remove());
        canvasReviewActions.style.display = 'none';
      }

      document.getElementById('btnSubmit').disabled = !document.getElementById('finalCheck').checked;
    }

    const checkFinal = document.getElementById('checkFinal');
    const finalCheckbox = document.getElementById('finalCheck');
    checkFinal.addEventListener('click', () => {
      finalCheckbox.checked = !finalCheckbox.checked;
      checkFinal.classList.toggle('checked', finalCheckbox.checked);
      document.getElementById('btnSubmit').disabled = !finalCheckbox.checked;
    });

    document.getElementById('btnEditDass').addEventListener('click', () => { setScreen('dass'); renderDassQuestion(); });
    document.getElementById('btnReviewBack').addEventListener('click', () => { setScreen('canvas'); });
    document.getElementById('btnSubmit').addEventListener('click', () => { setScreen('done'); launchConfetti(); });

    // Done
    document.getElementById('btnBackHome').addEventListener('click', () => location.reload());
    document.getElementById('btnDownload').addEventListener('click', () => alert('Bukti akan diunduh.'));

    // Confetti
    function launchConfetti() {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#6B9B7A', '#9DC4A8', '#8FB996', '#C5DEC9', '#4A7D5A'];
      for (let i = 0; i < 100; i++) {
        pieces.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, size: Math.random() * 8 + 4, color: colors[Math.floor(Math.random() * colors.length)], speed: Math.random() * 2 + 1, angle: Math.random() * Math.PI * 2, spin: Math.random() * 0.1 - 0.05 });
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        pieces.forEach(p => {
          if (p.y < canvas.height) {
            active = true; p.y += p.speed; p.x += Math.sin(p.angle); p.angle += p.spin;
            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle); ctx.fillStyle = p.color; ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); ctx.restore();
          }
        });
        if (active) requestAnimationFrame(animate);
      }
      animate();
    }

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (currentScreen === 'dass') {
        if (e.key >= '0' && e.key <= '3') { dassAnswers[qIndex] = parseInt(e.key); renderDassQuestion(); setTimeout(() => { if (qIndex < 20) { qIndex++; renderDassQuestion(); } }, 200); }
        if (e.key === 'ArrowLeft' && qIndex > 0) { qIndex--; renderDassQuestion(); }
        if (e.key === 'ArrowRight' && qIndex < 20) { qIndex++; renderDassQuestion(); }
      }
    });

    window.addEventListener('beforeunload', () => { try { if (isRecording) stopRecording(); if (stream) stream.getTracks().forEach(t => t.stop()); } catch {} });

    renderProgressChips();
  </script>
</body>
</html>